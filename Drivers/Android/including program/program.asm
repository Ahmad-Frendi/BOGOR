FCB:	EQU	5CH
READ:	EQU	20
SETDMA:	EQU	26
OPEN:	EQU	15
CLOSE:	EQU	16
CREATE:	EQU	22
DELETE:	EQU	19
BLKWRT:	EQU	40
GETSEG:	EQU	38
BUFSIZ:	EQU	1024

	ORG	100H
	PUT	100H

HEX2BIN:
	MOV	DI,FCB+9
	CMP	B,[DI]," "
	JNZ	HAVEXT
	MOV	SI,HEX
	MOVB
	MOVW
HAVEXT:
	MOV	CL,4		
	MOV	[OFFSET],-100H
	MOV	SI,FCB+11H	
	LODB
	CMP	AL," "		
	JZ	HAVOFF
	MOV	B,[SIGN],0	
	CMP	AL,"+"
	JZ	GETOFF		
	CMP	AL,"-"
	JNZ	GETOFF1		
	MOV	B,[SIGN],1	
GETOFF:
	LODB			
GETOFF1:
	CALL	HEXCHK		
	JC	HAVOFF		
	XOR	BX,BX		
CONVOFF:
	SHL	BX,CL		
	OR	BL,AL		
	LODB			
	CALL	HEXCHK		
	JNC	CONVOFF		
	TEST	B,[SIGN],-1	
	JZ	SAVOFF
	NEG	BX
SAVOFF:
	MOV	[OFFSET],BX
HAVOFF:
	MOV	DX,STARTSEG
	MOV	AX,DS
	ADD	DX,AX		
	MOV	AH,GETSEG
	INT	33
	MOV	ES,DX
	SEG	ES
	MOV	CX,[6]		
	MOV	[SEGSIZ],CX
	XOR	AX,AX
	MOV	DI,AX
	MOV	BP,AX
	SHR	CX
	REP
	STOC
	MOV	AH,OPEN
	MOV	DX,FCB
	INT	21H
	OR	AL,AL
	JNZ	NOFIL
	MOV	B,[FCB+32],0
	MOV	[FCB+14],BUFSIZ	
	MOV	DX,BUFFER
	MOV	AH,SETDMA
	INT	33
	MOV	AH,READ
	MOV	DX,FCB		
	MOV	SI,BUFFER+BUFSIZ 
READHEX:
	CALL	GETCH
	CMP	AL,":"		
	JNZ	READHEX
	CALL	GETBYT		
	MOV	CL,AL
	MOV	CH,0
	JCXZ	DONE
	CALL	GETBYT		
	MOV	BH,AL
	CALL	GETBYT		
	MOV	BL,AL
	ADD	BX,[OFFSET]	
	MOV	DI,BX
	CALL	GETBYT		
READLN:
	CMP	DI,[SEGSIZ]
	JAE	ADERR
	CALL	GETBYT		
	STOB
	CMP	DI,BP		
	JBE	HAVBIG
	MOV	BP,DI		
HAVBIG:
	LOOP	READLN
	JP	READHEX

NOFIL:
	MOV	DX,NOFILE
QUIT:
	MOV	AH,9
	INT	21H
	INT	20H

ADERR:
	MOV	DX,ADDR
	JMP	SHOWERR

GETCH:
	CMP	SI,BUFFER+BUFSIZ
	JNZ	NOREAD
	INT	21H
	CMP	AL,1
	JZ	ERROR
	MOV	SI,BUFFER
NOREAD:
	LODB
	CMP	AL,1AH
	JZ	DONE
	RET

GETBYT:
	CALL	HEXDIG
	MOV	BL,AL
	CALL	HEXDIG
	SHL	BL
	SHL	BL
	SHL	BL
	SHL	BL
	OR	AL,BL
	RET

HEXCHK:
	SUB	AL,"0"
	JC	RET
	CMP	AL,10
	JC	CMCRET
	SUB	AL,"A"-"0"-10
	JC	RET
	CMP	AL,16
CMCRET:
	CMC
	RET

HEXDIG:
	CALL	GETCH
	CALL	HEXCHK
	JNC	RET
ERROR:
	MOV	DX,ERRMES
SHOWERR:
	MOV	AH,9
	INT	21H
